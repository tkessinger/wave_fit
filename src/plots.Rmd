---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE}
library(tidyverse)
library(broom)
library(jsonlite)
library(scales)
library(cowplot)

theme_set(theme_cowplot(font_size = 10, font_family = "serif")) 

# Positive values are in inferno, negative in viridis
scale_viridis_to_inferno = 
  function(..., 
           alpha = 1, values = NULL,
           midpoint = 0, space = "Lab", na.value = "grey50", guide = "colourbar", aesthetics = aesthetics) {
    continuous_scale(
      aesthetics, "viridis_to_inferno",
      gradient_n_pal(c(viridis_pal(alpha, 0, 1, 1)(6),viridis_pal(alpha, 0.5, 1, direction=-1, option="B")(6)), 
                     values, space),
      na.value = na.value, guide = guide, ...,
      rescaler = function(x, to = c(0, 1), from = range(x, na.rm = TRUE)) { rescale_mid(x, to, from, midpoint) }
      )
  }
scale_fill_viridis_to_inferno = function(..., aesthetics = "fill") { scale_viridis_to_inferno(..., aesthetics = aesthetics) }
scale_color_viridis_to_inferno = function(..., aesthetics = "color") { scale_viridis_to_inferno(..., aesthetics = aesthetics) }

add_theme_elements = panel_border(colour="black", size=1) + theme(axis.line=element_blank(), aspect.ratio = 1, strip.background = element_blank())

tenx_format = trans_format("log10", math_format(10^.x))
```

## Read in data and plot crossing times and sweep times

```{r}
grid = read_csv("../output/grid/grid.csv")
sweep = read_csv("../output/grid_sweep/grid_sweep.csv")
```

### Plot crossing time and sweep time

```{r}
grid %>% group_by(K, delta, sigma) %>% summarize(m_crossing_time = log10(mean(crossing_time))) %>% 
  ggplot(aes(x=delta, y=K)) + 
  geom_raster(aes(fill=m_crossing_time)) + 
  scale_x_log10() + scale_y_log10() + annotation_logticks() + add_theme_elements + 
  labs(x = expression(delta), y = "N") +
  scale_fill_viridis_c(name = "Crossing time") +
  facet_wrap(~sigma, labeller = label_bquote(sigma==.(sigma)))

sweep %>% group_by(K, delta, sigma) %>% summarize(m_sweep_time = mean(crossing_time)) %>% mutate(sval = -delta) %>%
  ggplot(aes(x=sval, y=K)) + 
  geom_raster(aes(fill=m_sweep_time)) + 
  scale_x_log10() + scale_y_log10() + annotation_logticks() + add_theme_elements + 
  labs(x = "s", y = "N") +
  scale_fill_viridis_c(name = "Sweep time", trans = "log10") +
  facet_wrap(~sigma, labeller = label_bquote(sigma==.(sigma)))
```

### Plot ration of sweep times 

```{r}
sweep %>% group_by(K, delta, sigma) %>% summarize(m_sweep_time = mean(crossing_time)) %>% mutate(sval = -delta) %>%
  select(K,sigma,sval,m_sweep_time) %>% spread(sigma, m_sweep_time) %>% mutate(ratio = `0.05`/`5e-08`) %>%
  ggplot(aes(x=sval, y=K)) + 
  geom_raster(aes(fill=ratio)) + 
  scale_x_log10() + scale_y_log10() + annotation_logticks() + add_theme_elements + 
  labs(x = "s", y = "N") +
  scale_fill_viridis_c(name = "Ratio of sweep times", trans = "log10")
```

## Join together mean crossing time and sweep time and create alpha values

```{r}
g = grid %>% group_by(K, delta, sigma) %>% summarize(m_crossing_time = mean(crossing_time)) %>% ungroup() %>% select(K,sigma,m_crossing_time,delta)
s = sweep %>% group_by(K, delta, sigma) %>% summarize(m_sweep_time = mean(crossing_time)) %>% ungroup() %>% mutate(sval = -delta) %>% select(K,sval,sigma,m_sweep_time)

gs = full_join(g, s, by=c("K","sigma")) %>% mutate(alpha=m_crossing_time/m_sweep_time)
```

### Plot log(alpha) as a function of N, delta, and sigma

```{r}
p.logalpha = gs %>%
  ggplot(aes(x=delta, y=K)) + 
  geom_tile(aes(fill=log10(alpha), color=log10(alpha))) + 
  scale_x_log10(labels=tenx_format) + scale_y_log10(labels=tenx_format) + add_theme_elements + 
  labs(x = expression(delta), y = expression(italic(N))) +
  scale_fill_viridis_to_inferno(name = expression(log[10](italic(alpha[sigma])))) + scale_color_viridis_to_inferno(guide=FALSE) +
  facet_grid(sigma~sval, labeller = label_bquote(rows=sigma==.(sigma), cols=italic(s)[sweep]==.(sval)))
p.logalpha

ggsave("../output/log_alpha_s0-1.pdf", p.logalpha, width=6, units="in")
```

### Plot log ratio of alphas

```{r}
p.logratio = gs %>% select(K,sigma,delta,sval,alpha) %>% spread(sigma, alpha) %>% mutate(`0.05` = log10(`0.05`/`5e-08`), `0.5` = log10(`0.5`/`5e-08`)) %>% gather(`0.05`, `0.5`, key = sigma, value = ratio) %>%
  ggplot(aes(x=delta, y=K)) + 
  geom_tile(aes(fill=ratio, color=ratio)) + 
  scale_x_log10(labels=tenx_format) + scale_y_log10(labels=tenx_format) + add_theme_elements + 
  labs(x = expression(delta), y = expression(italic(N))) +
  scale_fill_viridis_to_inferno(name = expression(log[10](italic(alpha[sigma])/italic(alpha[5e-08])))) + scale_color_viridis_to_inferno(guide=FALSE) +
  facet_grid(sigma~sval, labeller = label_bquote(rows=sigma==.(sigma), cols=italic(s)[sweep]==.(sval)))
p.logratio

ggsave("../output/log_ratio_s0-1.pdf", p.logratio, width=6, units="in")
```

